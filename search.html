<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TinyJet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }
    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

<iframe id="iframe"></iframe>

<script src="https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js" defer></script>

<script type="module">
  import * as BareMux from "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/index.mjs";

  const { ScramjetController } = $scramjetLoadController();

  const scramjet = new ScramjetController({
    files: {
      wasm: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/wasm.wasm",
      all: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js",
      sync: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.sync.js"
    }
  });

  try {
    scramjet.init();
    navigator.serviceWorker.register("/sw.js");
  } catch (e) {
    console.error("scramjet init failed", e);
  }

  const connection = new BareMux.BareMuxConnection("/bareworker.js");

  async function initTransport() {
await connection.setTransport(
  "https://cdn.jsdelivr.net/npm/@mercuryworkshop/libcurl-transport/dist/index.mjs",
  [{ websocket: "wss://gointospace.app/wisp/" }]
);


  function normalizeUrl(input) {
    try {
      return new URL(input).toString();
    } catch {}

    try {
      const url = new URL("https://" + input);
      if (url.hostname.includes(".")) return url.toString();
    } catch {}

    return "https://search.brave.com/search?q=" + encodeURIComponent(input);
  }

  async function loadFromHash() {
    const hash = location.hash.slice(1);
    if (!hash) return;

    const url = normalizeUrl(hash);
    const encoded = scramjet.encodeUrl(url);
    document.getElementById("iframe").src = encoded;
  }

  await initTransport();
  loadFromHash();

  window.addEventListener("hashchange", loadFromHash);
</script>

</body>
</html>
